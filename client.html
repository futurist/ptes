<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<title>ptest client</title>
<style type="text/css">
*{
  margin: 0;
  padding: 0;
}
.imgCon,
.screenshot{
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

#phantom{
  position: relative;
}
#clipArea{
  position: absolute;
  z-index: 99999;
  border: 1px dashed #c00;
  display: none;
  pointer-events: none;
}
.clipBar{
  position: absolute;
  width: 100%;
  height: 100%;
  /*background: red;*/
  cursor: pointer;
}
.clipBar0{
  top:0;
  height: 10px;
}
.clipBar1{
  right:0;
  width: 10px;
}
.clipBar2{
  bottom:0;
  height: 10px;
}
.clipBar3{
  left:0;
  width: 10px;
}

</style>
</head>
<body>

<div id="phantom">
  <div class="imgCon" onselectstart="return false;" ondragstart="return false;" contenteditable=false><img onselectstart="return false;" ondragstart="return false;" contenteditable=false class="screenshot" /></div>
  <div id="clipArea">
    <div class="clipBar clipBar0"></div>
    <div class="clipBar clipBar1"></div>
    <div class="clipBar clipBar2"></div>
    <div class="clipBar clipBar3"></div>
  </div>
</div>
<div id="console"></div>

<script type="text/javascript" src="./node_modules/mithril/mithril.min.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/m_drag.js"></script>
<script type="text/javascript" src="./js/mousetrap.js"></script>
<script type="text/javascript" src="./node_modules/util_debounce_throttle/dist/util_debounce_throttle.js"></script>
<script type="text/javascript">
/*
Copyright @ Michael Yang
License MIT
*/

var RECORDING = 'STAGE_RECORDING', PLAYING = 'STAGE_PLAYING', CLIPPING = 'STAGE_CLIPPING'
var INVALID_NAME = '<>:"\\|?*'     // '<>:"/\\|?*'
var INVALID_NAME_REGEXP = new RegExp('['+INVALID_NAME.replace('\\','\\\\')+']','g')
var stage = null
var MODIFIER = {
  shift:  0x02000000,
  ctrl:   0x04000000,
  alt:    0x08000000,
  meta:   0x10000000,
  keypad: 0x20000000
}

var PageClip = {}
var clipDrag = m_drag({});
var startClip = clipDrag('clip', function(e, data, root){
  if(stage!=CLIPPING) return;
  PageClip.top = data.oy
  PageClip.left = data.ox
  PageClip.width = -data.dx
  PageClip.height = -data.dy
  applyPageClip()

}, function(e,data){
  if(stage!=CLIPPING) return;
  console.log(PageClip)
  ws._send({ type:'page_clip', data:PageClip })
  stage = null
})
function applyPageClip(){
  $('#clipArea').show().css({ top:PageClip.top+'px', left:PageClip.left+'px', width:PageClip.width+'px', height:PageClip.height+'px' })
}

$('#phantom').on('mousedown', startClip)

ws= new WebSocket('ws://'+ window.location.hostname +':1280')
ws.onopen = function (e) {
  ws.onmessage = function (message) {

      var msg; try{ msg=JSON.parse(message.data) }catch(e){ msg=message.data }
      if(typeof msg!='object'||!msg) return;

      switch(msg.type){

        case 'broadcast':

          break
        case 'page_clip':
          PageClip = msg.data
          applyPageClip()

          break
        case 'command':
          try{
            msg.result = eval( msg.data )
          }catch(e){
            msg.result = e.stack
          }
          delete msg.data
          msg.type = 'command_result'
          ws._send( msg )

          break
        case 'client_error':
          console.error( msg.data.msg, JSON.stringify(msg.data.stack) )

          break
        case 'client_console':
          console.log( msg.data )

          break
        case 'command_result':
          if(msg.__id){
            var cb = WS_CALLBACK[msg.__id]
            delete WS_CALLBACK[msg.__id]
            cb && cb(msg)
          }

          break
        case 'window_resize':
        case 'window_scroll':
          $(window).scrollLeft(msg.data.scrollX)
          $(window).scrollTop(msg.data.scrollY)
          $(window).width(msg.data.width)
          $(window).height(msg.data.height)

          break
        case 'render':
          $('.imgCon').width( msg.meta.size.width ).height( msg.meta.size.height )
          $('.screenshot').attr('src', 'data:image/png;base64,'+ msg.data)
          // FIXME: phantom don't have scrollbar but browser's scrollbar will reduce window size
          // if( msg.meta.count==0 ) $(window).trigger('resize')
          break

        default:

          break
      }

  }
  ws.onclose = function (code, reason, bClean) {
    console.log("ws error: ", code, reason);
  }
  ws._send({type:'connection', meta:'server', name:'client'})
}

var WS_CALLBACK = {}
ws._send = function(msg, cb){
  if(ws.readyState!=1) return;
  if(typeof cb=='function'){
    msg.__id = '_'+Date.now()+Math.random()
    WS_CALLBACK[msg.__id] = cb
  }
  ws.send( typeof msg=='string' ? msg : JSON.stringify(msg) )
}
ws._send_debounce = util_debounce_throttle._debounce( ws._send, 30)
ws._send_throttle = util_debounce_throttle._throttle( ws._send, 30, true )
ws._send_throttle2 = util_debounce_throttle._throttle( ws._send, 30, false )


function sc(str){
  ws._send({type:'command', meta:'server', data:str}, function(msg){
    if(msg.result!==undefined) console.log(msg.result)
  })
}
function cc(str){
  ws._send({type:'command', meta:'', data:str}, function(msg){
    if(msg.result!==undefined) console.log(msg.result)
  })
}

function registerEvent(){

    var lastTitle = ''
    Mousetrap.bind('ctrl+s', function(e){
      e.preventDefault()
      console.log(e)
    })
    // Mousetrap.bind('ctrl+p', function(e){
    //   e.preventDefault()
    //   if( stage==null ){
    //     sc(' playBack.play() ')
    //     stage = PLAYING
    //   } else if(stage == PLAYING) {
    //     sc(' playBack.pause() ')
    //     stage = null
    //   }
    // })
    Mousetrap.bind('ctrl+a', function(e){
      e.preventDefault()
      stage = CLIPPING
    })
    Mousetrap.bind('f4', function(e){
      if(!lastTitle) return
      e.preventDefault()
      sc(' snapKeyFrame("'+ lastTitle +'") ')
    })
    Mousetrap.bind('ctrl+r', function(e){
      e.preventDefault()
      var title
      if( stage == null ){
        while(1) {
          title= lastTitle = window.prompt('which title', lastTitle)||''
          if(!title) return
          if( INVALID_NAME_REGEXP.test(title) ) alert('path name cannot contain '+ INVALID_NAME)
          else break
        }
        document.title = 'recording...'+title
        sc(' startRec("'+ title +'") ')
        stage = RECORDING
      }else if(stage == RECORDING) {
        document.title = 'ptest'
        sc(' stopRec() ')
        stage = null
        lastTitle = ''
      }
    })

    $(window).on('resize', function(e){
      var data = { scrollX:window.scrollX, scrollY:window.scrollY, width:$(window).width(), height:$(window).height()}
      ws._send_debounce({ type:'window_resize', data:data })
    })
    $(window).trigger('resize')

    $(window).on('scroll', function(e){
      var data = { scrollX:window.scrollX, scrollY:window.scrollY, width:$(window).width(), height:$(window).height()}
      ws._send_throttle2({ type:'window_scroll', data:data })
    })
    $(window).trigger('scroll')


  var eventList = [
    'keydown',
    'keyup',
    'mousedown',
    'mouseup',
    'mousemove',
    // 'click',
    // 'dblclick',
  ]
  eventList.forEach(function(v){
    $(document).on(v, function(evt){
      evt.preventDefault()
      var e = evt.originalEvent
      var isKey = /key/.test(e.type)
      var modifier = 0
      if(e.shiftKey) modifier |= MODIFIER.shift
      if(e.altKey) modifier |= MODIFIER.alt
      if(e.ctrlKey) modifier |= MODIFIER.ctrl
      if(e.metaKey) modifier |= MODIFIER.meta
      var evtData = { type:e.type, which:e.which, modifier:modifier }
      if(isKey){
        evtData.keyName = e.key||e.keyIdentifier
        console.log(e,  e.key||e.keyIdentifier, e.keyIdentifier )
      }else{
        evtData.pageX = e.pageX-window.scrollX
        evtData.pageY = e.pageY-window.scrollY
      }
      // if(evtData.type=='mousemove') ws._send_throttle({ type:'event_mouse', data:evtData })
      // else ws._send({ type:'event_mouse', data:evtData })
      ws._send({ type:isKey?'event_key':'event_mouse', data:evtData })
    })
  })
}

$(function(){
  registerEvent()
  document.body.focus()
})

window.onunload = function(){
  $.ajax({ type:'GET', url: window.location.protocol+ '//'+ window.location.host + '/reload', async:false })
}

</script>
</body>
</html>